<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<link rel="stylesheet" href="{{ url_for('static', filename='common.css') }}" />
		<title>PSEUDOTUBE</title>
	</head>
	<body>
		<!-- Top Bar -->
		<header class="top-bar">
			<a href="/" class="logo">PSEUDOTUBE</a>

			<div class="text-bar">
				<input id="search-bar-input" type="text" class="input-text" placeholder="Search...">
			</div>

			<div class="right-section">
				{% if user.is_authenticated %}

				<button id="upload-button" class="btn red">Upload</button>

				<div class="btn-group">
					<p class="pill-button gray">
					<img src={{user.picture}} class="picture">
					{{user.email}}
					</p>
					<a href="{{ url_for('route_logout') }}" class="pill-button black" title="Logout">‚çà</a>
				</div>

				<div class="modal-overlay">
					<button id="upload-modal-close-button" class="btn gray modal-close">&times;</button>

					<div class="modal">
						<h2 class="modal-title">Upload File</h2>
						<p class="modal-description">Please choose a file to upload. You can also drag and drop it below.</p>

						<form class="upload-form" action="{{ url_for('route_upload') }}" method="post" enctype="multipart/form-data">
							<div class="form-group">
								<label for="video-title">Title</label>
								<input type="text" id="video-title" name="video-title" class="input-text" required>
							</div>

							<div class="form-group">
								<label for="video-desc">Description</label>
								<textarea id="video-desc" name="video-desc" class="textarea" rows="4" required></textarea>
							</div>

							<label for="file-upload" class="upload-area" id="upload-area">
								<input type="file" id="file-upload" name="file-upload" hidden required />
								<span id="upload-text">Click or drag file here to upload</span>
							</label>

							<progress id="upload-progress" value="0" max="100" style="width: 100%; display: none;"></progress>
							<p id="upload-status" style="font-size: 14px; color: #555;"></p>

							<button type="submit" class="btn red">Submit</button>
						</form>
					</div>
				</div>
				{% else %}
				<a href="{{ url_for('route_oauth2_authorize', provider='google') }}" class="btn red" title="Login">Login</a>
				{% endif %}
			</div>
		</header>

		<script>
			document.getElementById("search-bar-input")?.addEventListener('keypress', function (event) {
				if (event.key === 'Enter') {
					const query = this.value;
					if (query) {
						window.location.href = `/search?query=${encodeURIComponent(query)}`;
					}
				}
			});

			const uploadButton = document.getElementById("upload-button");
			const modal = document.querySelector('.modal-overlay');
			const closeButton = document.getElementById("upload-modal-close-button");

			if (uploadButton && modal && closeButton) {
				uploadButton.addEventListener('click', () => modal.classList.add('active'));
				closeButton.addEventListener('click', () => modal.classList.remove('active'));

				modal.addEventListener('click', (e) => {
					if (e.target === modal) modal.classList.remove('active');
				});

				const uploadArea = document.querySelector('.upload-area');
				const fileInput = document.getElementById('file-upload');
				const uploadText = document.getElementById('upload-text');

				uploadArea.addEventListener('dragover', (e) => {
					e.preventDefault();
					uploadArea.classList.add('dragging');
				});

				uploadArea.addEventListener('dragleave', () => {
					uploadArea.classList.remove('dragging');
				});

				uploadArea.addEventListener('drop', (e) => {
					e.preventDefault();
					uploadArea.classList.remove('dragging');
					fileInput.files = e.dataTransfer.files;
					uploadText.textContent = e.dataTransfer.files[0].name;
				});

				fileInput.addEventListener('change', () => {
					if (fileInput.files.length > 0) {
						uploadText.textContent = fileInput.files[0].name;
					} else {
						uploadText.textContent = 'Click or drag file here to upload';
					}
				});
			}

			document.addEventListener('DOMContentLoaded', function () {
				const form = document.querySelector('.upload-form');
				const progressBar = document.getElementById('upload-progress');
				const statusText = document.getElementById('upload-status');

				form.addEventListener('submit', function (e) {
					e.preventDefault(); // Stop regular form submission

					const formData = new FormData(form);

					const xhr = new XMLHttpRequest();
					xhr.open('POST', form.action, true);

					// Show progress bar
					progressBar.style.display = 'block';
					statusText.textContent = 'Uploading...';

					// Update progress bar
					xhr.upload.onprogress = function (e) {
						if (e.lengthComputable) {
							const percent = (e.loaded / e.total) * 100;
							progressBar.value = percent;
							statusText.textContent = `Uploading... ${Math.round(percent)}%`;
						}
					};

					// Handle complete
					xhr.onload = function () {
						if (xhr.status === 200) {
							progressBar.value = 100;
							statusText.textContent = 'Upload complete! Redirecting...';

							const response = JSON.parse(xhr.responseText);
							if (response.redirect_url) {
								setTimeout(() => {
									window.location.href = response.redirect_url;
								}, 1000);
							}
						} else {
							statusText.textContent = 'Upload failed. Please try again.';
						}
					};

					// Handle errors
					xhr.onerror = function () {
						statusText.textContent = 'An error occurred during upload.';
					};

					xhr.send(formData);
				});
			});
		</script>
	</body>
</html>
